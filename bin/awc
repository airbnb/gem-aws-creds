#!/usr/bin/env ruby

require 'trollop'
require 'awscreds'

parser = Trollop::Parser.new do
  banner 'AWS credentials exposer for command-line utilities'
  opt :list, 'List available credentials', :short => '-l'
  opt :verbose, 'Verbose (exposes secrets)', :short => '-v'
  opt :identity, 'Identity', :type => :string, :short => '-i'
  stop_on_unknown
end

opts = Trollop::with_standard_exception_handling parser do
  raise Trollop::HelpNeeded if ARGV.empty?
  parser.parse ARGV
end

store =AWSCreds::Store.new({:default => opts.identity})

if opts.list
  store.each do |name, creds|
    prefix = store.default?(name) ? '*' : ' '
    if opts.verbose
      puts "#{prefix}#{name}\t#{creds.access_key_id}\t#{creds.secret_access_key}"
    else
      puts "#{prefix}#{name}"
    end
  end
else
  creds = store.default_creds

  # set all the environment variables that various aws tools expect
  %w[AWS_ACCESS_KEY AWSAccessKeyId AWS_ACCESS_KEY_ID].each do |var|
    ENV[var] = creds.access_key_id
  end

  %w[AWS_SECRET_KEY AWSSecretKey AWS_SECRET_ACCESS_KEY].each do |var|
    ENV[var] = creds.access_key_id
  end

  exec(*ARGV)
end
